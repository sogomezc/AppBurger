<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Clientes</title>
  <!-- Estilos externos -->
  <link rel="stylesheet" href="../assets/css/estilosAdmin.css">
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div>
      <h2>Golden Burger</h2>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="gestorClientes.html" class="active">Clientes</a></li>
        <li><a href="gestorPedidos.html">Pedidos</a></li>
        <li><a href="productos.html">Productos</a></li>
      </ul>
    </div>
    <div class="logout">
      <a href="../login.html">Cerrar Sesión</a>
    </div>
  </div>

  <!-- Contenido -->
  <div class="content">
    <h1>Gestión de Clientes</h1>

    <table id="tablaClientes">
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre Cliente</th>
          <th>Fecha Registro</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Productos</th>
          <th>Total Gastado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const tbody = document.querySelector('#tablaClientes tbody');

    // Traemos usuarios y pedidos de localStorage
    let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];

    // Sincronizar usuarios con pedidos
    function sincronizarUsuariosConPedidos() {
      pedidos.forEach(p => {
        let usuario = usuarios.find(u => u.nombreCliente === p.nombre);
        if (!usuario) {
          usuarios.push({
            nombreCliente: p.nombre,
            fechaRegistro: p.fecha,
            tipoCliente: 'Cliente',
            estado: 'Activo',
            productos: [{ nombre: p.producto, precio: p.monto, cantidad: 1 }]
          });
        } else {
          const prodExistente = usuario.productos.find(pr => pr.nombre === p.producto);
          if (prodExistente) prodExistente.cantidad += 1;
          else usuario.productos.push({ nombre: p.producto, precio: p.monto, cantidad: 1 });
        }
      });
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
    }

    function renderTablaClientes() {
      sincronizarUsuariosConPedidos();
      tbody.innerHTML = '';

      usuarios.forEach((u, i) => {
        const total = u.productos.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
        const productosStr = u.productos.map(p => `${p.nombre} x${p.cantidad}`).join(', ');

        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${(i + 1).toString().padStart(2,'0')}</td>
          <td>${u.nombreCliente}</td>
          <td>${u.fechaRegistro}</td>
          <td>${u.tipoCliente}</td>
          <td>${u.estado}</td>
          <td>${productosStr}</td>
          <td>$${total}</td>
          <td><button class="deleteBtn" onclick="eliminarCliente(${i})">Eliminar</button></td>
        `;
        tbody.appendChild(fila);
      });

      localStorage.setItem('usuarios', JSON.stringify(usuarios));
    }

    function eliminarCliente(index) {
      if (confirm('¿Deseas eliminar este cliente y todos sus pedidos?')) {
        const cliente = usuarios[index];
        pedidos = pedidos.filter(p => p.nombre !== cliente.nombreCliente);
        localStorage.setItem('pedidos', JSON.stringify(pedidos));
        usuarios.splice(index, 1);
        renderTablaClientes();
      }
    }

    renderTablaClientes();
  </script>
</body>
</html>